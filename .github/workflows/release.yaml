# This starter workflow is for a CMake project running on a single platform. There is a different starter workflow if you need cross-platform coverage.
# See: https://github.com/actions/starter-workflows/blob/main/ci/cmake-multi-platform.yml
name: Release

on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      release_name:
        description: "Name of the release"
        required: true
        type: string
  workflow_call:
    inputs:
      release_name:
        description: "Name of the release"
        required: true
        type: string

permissions:
  contents: write
env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04]

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install dependencies
        run: |
          sudo apt-get update --fix-missing
          for i in {1..3}; do
            sudo apt-get install -y --fix-missing \
              libopencv-dev libpam0g-dev libcli11-dev \
              libwebkit2gtk-4.1-dev libssl-dev \
              libayatana-appindicator3-dev librsvg2-dev \
              patchelf && break || sleep 5
          done

      - name: Configure CMake
        env:
          PROJECT_VERSION: ${{ inputs.release_name || github.ref_name }}
        run: make package BUILD_TYPE=${{ env.BUILD_TYPE }} VERSION=${{ env.PROJECT_VERSION }}

      - name: Build
        run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}

      - name: Test
        working-directory: ${{github.workspace}}/build
        run: ctest -C ${{env.BUILD_TYPE}}

      - name: Package
        working-directory: ${{github.workspace}}/build
        run: |
          VERSION="${{ inputs.release_name || github.ref_name }}"
          OS="${{ matrix.os }}"

      
      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ inputs.release_name || github.ref_name }}
          name: ${{ inputs.release_name || github.ref_name }}
          files: |
            biopass-*.deb
            biopass-*.rpm

